<!doctype html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Receipt Generator — BelantikMaya (A4/A5) — Robust PDF</title>
  <style>
    :root{
      --brand-dark:#1f4d45;
      --accent:#ff8c42;
      --muted:#f5f5f5;
      --text:#111;
      --logo-size:88px;
      --gap:12px;
    }
    html,body{height:100%;margin:0;font-family:Inter, system-ui, Arial, sans-serif;color:var(--text);background:#faf9f6}
    .app{display:flex;gap:var(--gap);padding:12px;box-sizing:border-box;min-height:100vh}
    .col{flex:1 1 0;min-width:300px;background:#fff;padding:14px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,.06);box-sizing:border-box}
    label{display:block;font-size:13px;margin-top:12px;color:#333}
    input[type=text], input[type=number], textarea, select, input[type=date]{width:100%;padding:8px 10px;border:1px solid #e6e6e6;border-radius:6px;margin-top:6px;box-sizing:border-box}
    .row{display:flex;gap:10px}
    .row .col-inner{flex:1}
    button{background:var(--brand-dark);color:#fff;border:none;padding:10px 12px;border-radius:6px;cursor:pointer}
    button.secondary{background:#666}
    .actions{display:flex;gap:8px;margin-top:12px}
    .preview-viewport{width:100%;height:100%;display:flex;justify-content:center;align-items:flex-start}
    .receipt{width:100%;max-width:720px;background:#fff;padding:16px;box-sizing:border-box;position:relative;border:1px solid #eee}
    .header{display:flex;justify-content:space-between;align-items:flex-start;gap:12px}
    .company{display:flex;gap:12px;align-items:center}
    .logo{width:var(--logo-size);height:var(--logo-size);object-fit:contain}
    .company-info{font-size:13px}
    .company-info .biz{font-weight:700;color:var(--brand-dark);font-size:16px}
    .meta{font-size:13px;text-align:right;min-width:160px}
    .meta div{color:#444}
    .cust-inv{display:flex;justify-content:space-between;gap:12px;margin-top:12px}
    .cust{flex:1}
    .inv{flex:1;text-align:right}
    .cust .label{font-weight:700;margin-bottom:6px}
    table.items{width:100%;border-collapse:collapse;margin-top:12px}
    table.items th, table.items td{padding:8px;border-bottom:1px dashed #ddd;font-size:13px}
    table.items th{text-align:left}
    table.items td.numeric{text-align:right}
    .totals{margin-top:8px;display:flex;justify-content:flex-end}
    .totals table{width:360px;border-collapse:collapse}
    .totals td{padding:6px;font-size:13px}
    .totals .subtotal{font-weight:600}
    .totals .discount{font-weight:600}
    .totals .grand{font-weight:900;font-size:16px}
    .foot{margin-top:12px;font-size:12px;color:#555}
    @media(max-width:900px){
      .app{flex-direction:column}
      .header{flex-direction:column;align-items:flex-start}
      .meta{text-align:left;margin-top:8px}
      .cust-inv{flex-direction:column}
      .inv{text-align:left}
      .receipt{max-width:100%;padding:12px}
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="col" id="formCol">
      <h3>Konfigurasi Resit — BelantikMaya</h3>

      <label>Nama Perniagaan</label>
      <input id="bizName" type="text" value="BelantikMaya" />

      <label>Website</label>
      <input id="bizWebsite" type="text" value="https://belantikmaya.netlify.app" />

      <label>Email Perniagaan</label>
      <input id="bizEmail" type="text" value="info@belantikmaya.my" />

      <label>Alamat</label>
      <textarea id="bizAddr" rows="2">Petaling Jaya, Selangor</textarea>

      <div class="row">
        <div class="col-inner">
          <label>No. Telefon</label>
          <input id="bizPhone" type="text" value="012-3456789" />
        </div>
        <div class="col-inner">
          <label>No. Resit / Invois (Opsyenal)</label>
          <input id="invNo" type="text" placeholder="Kosong untuk auto" />
        </div>
      </div>

      <hr style="margin:12px 0;border-top:1px solid #eee" />

      <div class="row">
        <div class="col-inner">
          <label>Nama Pelanggan</label>
          <input id="custName" type="text" />
        </div>
        <div class="col-inner">
          <label>Email Pelanggan (opsyenal)</label>
          <input id="custEmail" type="text" />
        </div>
      </div>

      <div class="row">
        <div class="col-inner">
          <label>Telefon Pelanggan (opsyenal)</label>
          <input id="custPhone" type="text" />
        </div>
        <div class="col-inner">
          <label>Tarikh Resit</label>
          <input id="date" type="date" value="2025-10-27" />
        </div>
      </div>

      <label>Kaedah Bayaran</label>
      <select id="payMethod"><option>Tunai</option><option>Bank Transfer</option><option>Online</option></select>

      <hr style="margin:12px 0;border-top:1px solid #eee" />

      <h4>Item</h4>
      <table id="itemsTable" style="width:100%;border-collapse:collapse">
        <thead>
          <tr><th style="text-align:left">Deskripsi</th><th style="width:70px">Qty</th><th style="width:120px">Harga (RM)</th><th style="width:100px">Jumlah</th><th style="width:40px"></th></tr>
        </thead>
        <tbody></tbody>
      </table>

      <div style="margin-top:8px;display:flex;gap:8px">
        <button id="addRow">Tambah Baris</button>
        <button class="secondary" id="resetRows">Reset</button>
      </div>

      <hr style="margin:12px 0;border-top:1px solid #eee" />

      <label>Diskaun</label>
      <div class="row">
        <div class="col-inner">
          <select id="discountType"><option value="none">Tiada</option><option value="percent">Peratus (%)</option><option value="amount">Jumlah (RM)</option></select>
        </div>
        <div class="col-inner">
          <input id="discountValue" type="number" min="0" step="0.01" placeholder="0" />
        </div>
      </div>

      <label>Pilihan Saiz Kertas</label>
      <select id="paperSize"><option value="a4">A4 (210 × 297 mm)</option><option value="a5">A5 (148 × 210 mm)</option></select>

      <div class="actions">
        <button id="updatePreview">Kemas kini Preview</button>
        <button id="printBtn" style="background:var(--accent)">Cetak Resit</button>
      </div>

    </div>

    <div class="col" id="previewCol">
      <div class="preview-viewport">
        <div id="receipt" class="receipt" role="document">
          <div class="header">
            <div class="company">
              <img src="logo.webp" class="logo" id="logoImg" alt="logo" onerror="this.style.display='none'" />
              <div class="company-info">
                <div class="biz" id="rBizName">BelantikMaya</div>
                <div class="muted" id="rBizAddr">Petaling Jaya, Selangor</div>
                <div class="muted" id="rBizPhone">012-3456789</div>
                <div class="muted" id="rBizWebsite">https://belantikmaya.netlify.app</div>
                <div class="muted" id="rBizEmail">info@belantikmaya.my</div>
              </div>
            </div>

            <div class="meta" id="metaHeader">
              <div>No: <span id="rInv">INV-2025-001</span></div>
              <div>Tarikh: <span id="rDate">27 Okt 2025</span></div>
              <div>Kaedah: <span id="rPay">Tunai</span></div>
            </div>
          </div>

          <div class="cust-inv">
            <div class="cust">
              <div class="label">BIL KEPADA / CUSTOMER</div>
              <div id="rCustName">-</div>
              <div id="rCustEmail"></div>
              <div id="rCustPhone"></div>
            </div>
            <div class="inv"></div>
          </div>

          <table class="items" id="rItems">
            <thead><tr><th>Perkara</th><th style="text-align:right">Qty</th><th style="text-align:right">Harga</th><th style="text-align:right">Jumlah</th></tr></thead>
            <tbody></tbody>
            <tfoot>
              <tr><td colspan="2"></td><td style="text-align:right" class="subtotal">Subtotal</td><td style="text-align:right" id="rSubtotal">0.00</td></tr>
              <tr><td colspan="2"></td><td style="text-align:right" class="discount">Diskaun</td><td style="text-align:right" id="rDiscount">0.00</td></tr>
              <tr><td colspan="2"></td><td style="text-align:right" class="grand">Jumlah</td><td style="text-align:right" id="rTotal">0.00</td></tr>
            </tfoot>
          </table>

          <div class="foot">Terima kasih kerana memilih BelantikMaya. Semua jualan tertakluk kepada terma & syarat.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- html2pdf bundle -->
  <script src="https://unpkg.com/html2pdf.js@0.9.3/dist/html2pdf.bundle.min.js"></script>

  <script>
  document.addEventListener('DOMContentLoaded', function () {
    const to2 = v => Number(v || 0).toFixed(2);
    const escapeHtml = s => String(s || '').replace(/[&<>"]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
    const itemsBody = document.querySelector('#itemsTable tbody');

    function addItemRow(desc = '', qty = 1, price = 0) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input class="itm-desc" type="text" value="${escapeHtml(desc)}" /></td>
        <td><input class="itm-qty" type="number" min="1" value="${qty}" /></td>
        <td><input class="itm-price" type="number" min="0" step="0.01" value="${price}" /></td>
        <td class="itm-sum">${to2(qty * price)}</td>
        <td><button type="button" class="del">-</button></td>
      `;
      itemsBody.appendChild(tr);

      const descEl = tr.querySelector('.itm-desc');
      const qtyEl = tr.querySelector('.itm-qty');
      const priceEl = tr.querySelector('.itm-price');
      const delBtn = tr.querySelector('.del');

      function onRowChange() {
        const q = Number(qtyEl.value || 0);
        const p = Number(priceEl.value || 0);
        tr.querySelector('.itm-sum').textContent = to2(q * p);
        updatePreview();
      }

      descEl.addEventListener('input', updatePreview);
      qtyEl.addEventListener('input', onRowChange);
      priceEl.addEventListener('input', onRowChange);
      delBtn.addEventListener('click', () => { tr.remove(); updatePreview(); });
    }

    function seedRows() {
      if (!document.querySelectorAll('#itemsTable tbody tr').length) {
        addItemRow('Magnetic Insect Screen', 1, 50);
        addItemRow('Installation', 1, 30);
      }
    }

    function formatDateToMalay(dstr) {
      if (!dstr) return '';
      const dt = new Date(dstr);
      if (isNaN(dt.getTime())) return dstr;
      return dt.toLocaleDateString('ms-MY', { day: '2-digit', month: 'short', year: 'numeric' });
    }

    function updatePreview() {
      document.getElementById('rBizName').textContent = (document.getElementById('bizName') || {}).value || 'BelantikMaya';
      document.getElementById('rBizAddr').textContent = (document.getElementById('bizAddr') || {}).value || '';
      document.getElementById('rBizPhone').textContent = (document.getElementById('bizPhone') || {}).value || '';
      document.getElementById('rBizWebsite').textContent = (document.getElementById('bizWebsite') || {}).value || '';
      document.getElementById('rBizEmail').textContent = (document.getElementById('bizEmail') || {}).value || '';

      const invField = (document.getElementById('invNo') || {}).value || '';
      const invNo = invField.trim() || ('INV-' + new Date().toISOString().slice(0,10).replace(/-/g,'') + '-' + String(Math.floor(Math.random()*900+100)));
      document.getElementById('rInv').textContent = invNo;

      const dateVal = (document.getElementById('date') || {}).value || new Date().toISOString().slice(0,10);
      document.getElementById('rDate').textContent = formatDateToMalay(dateVal);

      document.getElementById('rPay').textContent = (document.getElementById('payMethod') || {}).value || '';

      document.getElementById('rCustName').textContent = (document.getElementById('custName') || {}).value || '-';
      const ce = (document.getElementById('custEmail') || {}).value || '';
      const cp = (document.getElementById('custPhone') || {}).value || '';
      document.getElementById('rCustEmail').textContent = ce ? ('Email: ' + ce) : '';
      document.getElementById('rCustPhone').textContent = cp ? ('Tel: ' + cp) : '';

      // build items
      const tbody = document.querySelector('#rItems tbody'); tbody.innerHTML = '';
      let subtotal = 0;
      document.querySelectorAll('#itemsTable tbody tr').forEach(r => {
        const d = (r.querySelector('.itm-desc') || {}).value || '';
        const q = Number((r.querySelector('.itm-qty') || {}).value || 0);
        const p = Number((r.querySelector('.itm-price') || {}).value || 0);
        const s = q * p; subtotal += s;
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(d)}</td><td class="numeric">${q}</td><td class="numeric">${to2(p)}</td><td class="numeric">${to2(s)}</td>`;
        tbody.appendChild(tr);
      });

      const discType = (document.getElementById('discountType') || {}).value || 'none';
      const discVal = Number((document.getElementById('discountValue') || {}).value || 0);
      let discAmt = 0;
      if (discType === 'percent') discAmt = subtotal * (discVal / 100);
      else if (discType === 'amount') discAmt = discVal;
      if (discAmt < 0) discAmt = 0;
      if (discAmt > subtotal) discAmt = subtotal;

      const total = subtotal - discAmt;
      document.getElementById('rSubtotal').textContent = to2(subtotal);
      document.getElementById('rDiscount').textContent = discAmt ? ('-' + to2(discAmt)) : '0.00';
      document.getElementById('rTotal').textContent = to2(total);
    }

    // helper: wait for images
    function waitForImages(container) {
      const imgs = Array.from(container.querySelectorAll('img'));
      return Promise.all(imgs.map(img => {
        if (img.complete) return Promise.resolve();
        return new Promise(res => { img.addEventListener('load', res); img.addEventListener('error', res); });
      }));
    }

    // attempt PDF generation with retries & fallbacks
    async function generatePdfRobust() {
      updatePreview();
      const receipt = document.getElementById('receipt');
      await waitForImages(receipt);

      // clone element
      const clone = receipt.cloneNode(true);

      // pick paper
      const paper = (document.getElementById('paperSize') || {}).value || 'a4';
      clone.style.background = '#fff';

      // try strategies in order
      const attempts = [
        {scale: 2, useCORS: true, desc: 'High quality (scale=2)'},
        {scale: 1.5, useCORS: true, desc: 'Medium quality (scale=1.5)'},
        {scale: 1, useCORS: true, desc: 'Low quality (scale=1)'},
        {scale: 1, useCORS: false, desc: 'Low quality, no CORS (scale=1)'}
      ];

      // We'll set width according to paper so html2pdf scales correctly
      if (paper === 'a4') clone.style.width = '210mm';
      else clone.style.width = '148mm';

      // wrapper
      const wrapper = document.createElement('div'); wrapper.style.position='fixed'; wrapper.style.left='-9999px'; wrapper.appendChild(clone); document.body.appendChild(wrapper);

      let lastErr = null;
      for (let i = 0; i < attempts.length; i++) {
        const a = attempts[i];
        try {
          // ensure cloned imgs have crossorigin set when requested
          if (a.useCORS) {
            Array.from(clone.querySelectorAll('img')).forEach(img => { try { img.setAttribute('crossorigin','anonymous'); } catch(e){} });
          } else {
            Array.from(clone.querySelectorAll('img')).forEach(img => { try { img.removeAttribute('crossorigin'); } catch(e){} });
          }

          const opts = {
            margin: [8,8,8,8],
            filename: ((document.getElementById('invNo')||{}).value || 'resit') + '.pdf',
            image: { type: 'jpeg', quality: 0.97 },
            html2canvas: { scale: a.scale, useCORS: a.useCORS, allowTaint: !a.useCORS },
            jsPDF: { unit: 'mm', format: paper, orientation: 'portrait' }
          };

          console.info('Percubaan PDF:', a.desc);
          await html2pdf().set(opts).from(clone).save();
          // success -> cleanup and return
          document.body.removeChild(wrapper);
          return;
        } catch (err) {
          console.error('Percubaan PDF gagal:', attempts[i], err);
          lastErr = err;
          // continue to next attempt
        }
      }

      // all attempts failed -> cleanup & fallback
      document.body.removeChild(wrapper);
      console.error('Semua percubaan PDF gagal. Ralat terakhir:', lastErr);
      alert('Gagal hasilkan PDF secara automatik. Buka Print dialog sebagai fallback (OK untuk teruskan). Ralat: ' + (lastErr && lastErr.message ? lastErr.message : 'unknown'));
      // fallback to window.print
      setTimeout(()=>{ window.print(); }, 250);
    }

    // bind UI
    function bindUI() {
      ['bizName','bizAddr','bizPhone','bizWebsite','bizEmail','custName','custEmail','custPhone','invNo','date','payMethod','discountType','discountValue','paperSize'].forEach(id=>{
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', updatePreview);
      });
      document.getElementById('updatePreview').addEventListener('click', updatePreview);
      document.getElementById('addRow').addEventListener('click', ()=>{ addItemRow('Perkara',1,0); updatePreview(); });
      document.getElementById('resetRows').addEventListener('click', ()=>{ itemsBody.innerHTML=''; updatePreview(); seedRows(); });
      document.getElementById('printBtn').addEventListener('click', generatePdfRobust);
    }

    // init
    seedRows();
    bindUI();
    updatePreview();
  });
  </script>
</body>
</html>
